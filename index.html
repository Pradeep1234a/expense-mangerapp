<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AI Student Expense Manager - Smart budgeting for students">
<meta name="theme-color" content="#0f0f1a">
<title>StudyWallet ‚Äî AI Student Expense Manager</title>
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22StudyWallet%22%2C%22short_name%22%3A%22StudyWallet%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f0f1a%22%2C%22theme_color%22%3A%22%230f0f1a%22%7D">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0a0a14;
  --surface: #12121f;
  --surface2: #1a1a2e;
  --border: #2a2a45;
  --text: #e8e8f0;
  --text2: #8888aa;
  --accent: #7c6af5;
  --accent2: #f56a6a;
  --accent3: #6af5b8;
  --accent4: #f5c86a;
  --glow: rgba(124,106,245,0.3);
  --radius: 16px;
  --font-head: 'Syne', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}
[data-theme="light"] {
  --bg: #f0f0fa;
  --surface: #ffffff;
  --surface2: #e8e8f8;
  --border: #d0d0e8;
  --text: #1a1a2e;
  --text2: #5555880;
  --glow: rgba(124,106,245,0.15);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font-body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background 0.3s,color 0.3s}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 30% 20%,rgba(124,106,245,0.08) 0%,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(245,106,106,0.06) 0%,transparent 50%);pointer-events:none;z-index:0}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* LAYOUT */
.app{display:flex;min-height:100vh;position:relative;z-index:1}
.sidebar{width:240px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:24px 16px;position:fixed;height:100vh;overflow-y:auto;z-index:100;transition:transform 0.3s}
.main{flex:1;margin-left:240px;padding:32px;min-height:100vh}
.logo{display:flex;align-items:center;gap:10px;margin-bottom:40px;padding:0 8px}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
.logo-text{font-family:var(--font-head);font-weight:800;font-size:18px;background:linear-gradient(135deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-section{margin-bottom:8px;padding:0 8px}
.nav-label{font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:8px;margin-top:16px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.2s;font-size:14px;font-weight:500;color:var(--text2);border:none;background:none;width:100%;text-align:left}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:linear-gradient(135deg,rgba(124,106,245,0.2),rgba(245,106,106,0.1));color:var(--accent);border:1px solid rgba(124,106,245,0.3)}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center}
.page{display:none;animation:fadeIn 0.3s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* HEADER */
.page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;flex-wrap:wrap;gap:16px}
.page-title{font-family:var(--font-head);font-size:28px;font-weight:800;line-height:1.1}
.page-subtitle{color:var(--text2);font-size:14px;margin-top:4px}
.header-actions{display:flex;align-items:center;gap:10px}

/* BUTTONS */
.btn{padding:10px 20px;border-radius:10px;font-family:var(--font-body);font-size:14px;font-weight:500;cursor:pointer;border:none;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),#9b8af7);color:#fff;box-shadow:0 4px 20px var(--glow)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 28px var(--glow)}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface2);color:var(--text)}
.btn-danger{background:rgba(245,106,106,0.15);color:var(--accent2);border:1px solid rgba(245,106,106,0.3)}
.btn-sm{padding:6px 14px;font-size:13px}
.btn-icon{width:36px;height:36px;padding:0;border-radius:10px;justify-content:center}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;transition:all 0.2s}
.card:hover{border-color:var(--accent);box-shadow:0 0 0 1px rgba(124,106,245,0.1),0 8px 32px rgba(0,0,0,0.2)}
.card-sm{padding:16px}
.grid{display:grid;gap:20px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}

/* STAT CARDS */
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:0.15;transition:opacity 0.2s}
.stat-card.income::before{background:var(--accent3)}
.stat-card.expense::before{background:var(--accent2)}
.stat-card.balance::before{background:var(--accent)}
.stat-card.days::before{background:var(--accent4)}
.stat-card:hover::before{opacity:0.25}
.stat-label{font-size:12px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text2);font-weight:600;margin-bottom:8px}
.stat-value{font-family:var(--font-head);font-size:28px;font-weight:800;line-height:1}
.stat-sub{font-size:12px;color:var(--text2);margin-top:6px}
.stat-icon{position:absolute;top:20px;right:20px;font-size:22px;opacity:0.6}

/* PROGRESS */
.progress-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(.34,1.56,.64,1)}
.progress-fill.good{background:linear-gradient(90deg,var(--accent3),#4af0a0)}
.progress-fill.warn{background:linear-gradient(90deg,var(--accent4),#f0a04a)}
.progress-fill.danger{background:linear-gradient(90deg,var(--accent2),#f04a4a)}

/* FORMS */
.form-group{margin-bottom:16px}
label{display:block;font-size:13px;font-weight:500;color:var(--text2);margin-bottom:6px}
input,select,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:var(--font-body);font-size:14px;transition:all 0.2s;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,106,245,0.15)}
select option{background:var(--surface2);color:var(--text)}
textarea{resize:vertical;min-height:80px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.2s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:480px;transform:scale(0.95) translateY(10px);transition:transform 0.2s}
.modal-overlay.open .modal{transform:scale(1) translateY(0)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.modal-title{font-family:var(--font-head);font-size:20px;font-weight:700}
.toggle-tab{display:flex;gap:4px;background:var(--surface2);border-radius:10px;padding:4px;margin-bottom:20px}
.toggle-btn{flex:1;padding:8px;border-radius:8px;border:none;cursor:pointer;font-family:var(--font-body);font-size:13px;font-weight:500;background:none;color:var(--text2);transition:all 0.2s}
.toggle-btn.active{background:var(--accent);color:#fff}

/* TRANSACTIONS */
.tx-list{display:flex;flex-direction:column;gap:8px}
.tx-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:12px;transition:all 0.2s}
.tx-item:hover{border-color:var(--accent);background:var(--surface2)}
.tx-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.tx-info{flex:1;min-width:0}
.tx-name{font-weight:500;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-meta{font-size:12px;color:var(--text2);margin-top:2px}
.tx-amount{font-family:var(--font-head);font-size:16px;font-weight:700;white-space:nowrap}
.tx-amount.income{color:var(--accent3)}
.tx-amount.expense{color:var(--accent2)}
.tx-actions{display:flex;gap:6px;opacity:0;transition:opacity 0.2s}
.tx-item:hover .tx-actions{opacity:1}
.category-badge{display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;background:rgba(124,106,245,0.15);color:var(--accent)}

/* CHARTS */
.chart-container{position:relative;height:260px}
canvas{max-width:100%}

/* FAB */
.fab{position:fixed;bottom:32px;right:32px;width:56px;height:56px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:50%;border:none;cursor:pointer;font-size:24px;color:#fff;box-shadow:0 8px 24px var(--glow);transition:all 0.3s;z-index:500;display:flex;align-items:center;justify-content:center}
.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 12px 32px var(--glow)}

/* CHATBOT */
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 200px);min-height:400px}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.chat-msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;animation:fadeIn 0.3s}
.chat-msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#9b8af7);color:#fff;border-bottom-right-radius:4px}
.chat-msg.ai{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px}
.chat-msg.ai.typing{display:flex;gap:4px;align-items:center;padding:16px}
.dot{width:8px;height:8px;background:var(--text2);border-radius:50%;animation:bounce 1.2s infinite}
.dot:nth-child(2){animation-delay:0.2s}
.dot:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
.chat-input-area{display:flex;gap:10px;padding-top:16px;border-top:1px solid var(--border);margin-top:auto}
.chat-input-area input{flex:1}
.chat-mode-tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.mode-tab{padding:7px 14px;border-radius:20px;border:1px solid var(--border);background:none;cursor:pointer;font-size:12px;font-weight:600;color:var(--text2);transition:all 0.2s;font-family:var(--font-body)}
.mode-tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* GAMES */
.game-canvas{border-radius:12px;background:var(--surface2);border:2px solid var(--border);cursor:pointer}
.game-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:12px 16px;background:var(--surface2);border-radius:10px}
.game-score{font-family:var(--font-head);font-size:24px;font-weight:800;color:var(--accent)}
.game-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.game-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;text-align:center;transition:all 0.2s}
.game-card:hover,.game-card.selected{border-color:var(--accent);background:rgba(124,106,245,0.1)}
.game-card.correct{border-color:var(--accent3);background:rgba(106,245,184,0.1)}
.game-card.wrong{border-color:var(--accent2);background:rgba(245,106,106,0.1)}

/* LEADERBOARD */
.lb-item{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;background:var(--surface2);margin-bottom:6px}
.lb-rank{width:28px;height:28px;border-radius:8px;background:var(--accent);color:#fff;font-family:var(--font-head);font-weight:800;font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.lb-rank.gold{background:linear-gradient(135deg,#f5c86a,#f5a06a)}
.lb-rank.silver{background:linear-gradient(135deg,#aaa,#888)}
.lb-rank.bronze{background:linear-gradient(135deg,#c87a3a,#a05020)}

/* INSIGHTS */
.insight-card{padding:14px 16px;border-radius:12px;border-left:3px solid;margin-bottom:10px;font-size:13px;line-height:1.5}
.insight-card.info{background:rgba(124,106,245,0.1);border-color:var(--accent)}
.insight-card.warn{background:rgba(245,200,106,0.1);border-color:var(--accent4)}
.insight-card.good{background:rgba(106,245,184,0.1);border-color:var(--accent3)}
.insight-card.alert{background:rgba(245,106,106,0.1);border-color:var(--accent2)}
.insight-icon{font-size:16px;margin-right:8px}

/* MISC */
.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
.badge-purple{background:rgba(124,106,245,0.2);color:var(--accent)}
.badge-green{background:rgba(106,245,184,0.2);color:var(--accent3)}
.badge-red{background:rgba(245,106,106,0.2);color:var(--accent2)}
.empty-state{text-align:center;padding:48px 20px;color:var(--text2)}
.empty-state .empty-icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-family:var(--font-head);font-size:18px;color:var(--text);margin-bottom:6px}
.divider{height:1px;background:var(--border);margin:20px 0}
.tag{font-family:var(--font-mono);font-size:11px;padding:2px 8px;background:var(--surface2);border-radius:4px;color:var(--text2)}
.survival-meter{position:relative;padding:20px;background:linear-gradient(135deg,rgba(124,106,245,0.15),rgba(245,106,106,0.1));border:1px solid rgba(124,106,245,0.3);border-radius:16px;text-align:center}
.survival-days{font-family:var(--font-head);font-size:56px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent3));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.theme-toggle{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.theme-toggle:hover{border-color:var(--accent)}
.notification{position:fixed;bottom:100px;right:32px;background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:12px 16px;font-size:13px;font-weight:500;transform:translateY(20px);opacity:0;transition:all 0.3s;z-index:2000;max-width:280px}
.notification.show{transform:translateY(0);opacity:1}
.notification.success{border-color:var(--accent3);color:var(--accent3)}
.notification.error{border-color:var(--accent2);color:var(--accent2)}
.section-title{font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.inline-edit{display:none}
.editing .inline-edit{display:flex}
.editing .display-val{display:none}
.amount-display{font-family:var(--font-head)}
.share-link{display:flex;gap:8px;margin-top:12px}
.share-link input{font-family:var(--font-mono);font-size:12px}

/* Reaction Game */
.reaction-target{position:absolute;width:60px;height:60px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;transition:transform 0.1s;user-select:none}
.reaction-target:hover{transform:scale(1.1)}
#reactionArea{position:relative;width:100%;height:300px;background:var(--surface2);border-radius:12px;overflow:hidden;border:2px solid var(--border)}

/* MOBILE */
.hamburger{display:none;position:fixed;top:20px;left:20px;z-index:200;width:40px;height:40px;border-radius:10px;background:var(--surface);border:1px solid var(--border);cursor:pointer;font-size:18px;align-items:center;justify-content:center}
.overlay-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:90}
@media(max-width:768px){
  .hamburger{display:flex}
  .sidebar{transform:translateX(-260px)}
  .sidebar.open{transform:translateX(0)}
  .overlay-backdrop.open{display:block}
  .main{margin-left:0;padding:24px 16px;padding-top:70px}
  .grid-4{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr}
  .grid-2{grid-template-columns:1fr}
  .fab{bottom:20px;right:20px}
  .page-title{font-size:22px}
  .survival-days{font-size:40px}
}
@media(max-width:480px){
  .grid-4,.grid-3{grid-template-columns:1fr}
  .modal{padding:20px}
}

/* ANIMATIONS */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.loading{animation:pulse 1.5s infinite}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}

/* SETTINGS */
.profile-avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-family:var(--font-head);font-size:24px;font-weight:800;color:#fff;flex-shrink:0}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.switch{position:relative;width:44px;height:24px;display:inline-block;cursor:pointer}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;inset:0;background:var(--border);border-radius:12px;transition:0.3s}
.slider::before{content:'';position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:0.3s}
input:checked+.slider{background:var(--accent)}
input:checked+.slider::before{transform:translateX(20px)}
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleSidebar()">‚ò∞</button>
<div class="overlay-backdrop" id="sideOverlay" onclick="toggleSidebar()"></div>

<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="logo">
    <div class="logo-icon">üí∞</div>
    <span class="logo-text">StudyWallet</span>
  </div>
  <nav>
    <div class="nav-label">Main</div>
    <button class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">üè†</span> Dashboard</button>
    <button class="nav-item" onclick="showPage('transactions')"><span class="nav-icon">üìã</span> Transactions</button>
    <button class="nav-item" onclick="showPage('analytics')"><span class="nav-icon">üìä</span> Analytics</button>
    <div class="nav-label">Tools</div>
    <button class="nav-item" onclick="showPage('budget')"><span class="nav-icon">üéØ</span> Budget Goals</button>
    <button class="nav-item" onclick="showPage('income')"><span class="nav-icon">üíµ</span> Income</button>
    <div class="nav-label">AI & Fun</div>
    <button class="nav-item" onclick="showPage('chatbot')"><span class="nav-icon">ü§ñ</span> AI Coach</button>
    <button class="nav-item" onclick="showPage('games')"><span class="nav-icon">üéÆ</span> Fun Zone</button>
    <div class="nav-label">Settings</div>
    <button class="nav-item" onclick="showPage('settings')"><span class="nav-icon">‚öôÔ∏è</span> Settings</button>
  </nav>
  <div style="margin-top:auto;padding-top:20px">
    <div style="padding:12px;background:var(--surface2);border-radius:10px;font-size:12px;color:var(--text2);text-align:center">
      <div style="font-size:20px;margin-bottom:4px">üéì</div>
      <div style="font-weight:600;color:var(--text);margin-bottom:2px" id="sidebarUsername">Student</div>
      <div id="sidebarBalance" style="font-family:var(--font-mono);color:var(--accent3)">$0.00 left</div>
    </div>
  </div>
</aside>

<!-- MAIN CONTENT -->
<main class="main">

<!-- ==================== DASHBOARD ==================== -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <div>
      <div class="page-title">Good morning, <span id="greetName">Student</span> üëã</div>
      <div class="page-subtitle" id="dashDate">Loading date...</div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
      <button class="btn btn-ghost btn-sm" onclick="generateShareLink()">üîó Share Summary</button>
    </div>
  </div>

  <!-- STAT CARDS -->
  <div class="grid grid-4" style="margin-bottom:20px">
    <div class="stat-card income">
      <div class="stat-label">Total Income</div>
      <div class="stat-value amount-display" id="totalIncome">$0</div>
      <div class="stat-sub">This month</div>
      <div class="stat-icon">üí∞</div>
    </div>
    <div class="stat-card expense">
      <div class="stat-label">Total Spent</div>
      <div class="stat-value amount-display" id="totalExpense">$0</div>
      <div class="stat-sub">This month</div>
      <div class="stat-icon">üõí</div>
    </div>
    <div class="stat-card balance">
      <div class="stat-label">Balance</div>
      <div class="stat-value amount-display" id="balance">$0</div>
      <div class="stat-sub" id="balanceStatus">Looking good!</div>
      <div class="stat-icon">üí≥</div>
    </div>
    <div class="stat-card days">
      <div class="stat-label">Daily Limit</div>
      <div class="stat-value amount-display" id="dailyLimit">$0</div>
      <div class="stat-sub">Safe to spend/day</div>
      <div class="stat-icon">üìÖ</div>
    </div>
  </div>

  <!-- SURVIVAL + SAVINGS -->
  <div class="grid grid-2" style="margin-bottom:20px">
    <div class="survival-meter">
      <div style="font-size:12px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:8px;font-weight:600">Money Survival</div>
      <div class="survival-days" id="survivalDays">0</div>
      <div style="font-size:14px;color:var(--text2);margin-top:4px">days remaining</div>
      <div style="font-size:12px;color:var(--text2);margin-top:8px">Based on your avg daily spend</div>
    </div>
    <div class="card">
      <div class="section-title">üéØ Savings Goal</div>
      <div id="savingsGoalDisplay">
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
          <span id="savingsLabel" style="color:var(--text2);font-size:14px">Monthly Goal</span>
          <span id="savingsProgress" style="font-family:var(--font-head);font-size:18px;font-weight:700">$0/$0</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill good" id="savingsBar" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--text2)">
          <span>0% saved</span>
          <span id="savingsPct">Set a goal ‚Üí</span>
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:12px;width:100%" onclick="openGoalModal()">+ Set Goal</button>
    </div>
  </div>

  <!-- INSIGHTS + RECENT -->
  <div class="grid grid-2">
    <div class="card">
      <div class="section-title">üí° AI Insights</div>
      <div id="insightsContainer">
        <div class="insight-card info"><span class="insight-icon">‚ÑπÔ∏è</span>Add your income and expenses to get personalized insights!</div>
      </div>
    </div>
    <div class="card">
      <div class="section-title">‚ö° Recent Transactions</div>
      <div id="recentTx">
        <div class="empty-state" style="padding:24px">
          <div class="empty-icon">üì≠</div>
          <div>No transactions yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SHARE LINK -->
  <div id="shareSection" style="display:none;margin-top:20px" class="card">
    <div class="section-title">üîó Share with Parents</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:10px">Share this read-only link to show your parents your expense summary.</div>
    <div class="share-link">
      <input type="text" id="shareUrlInput" readonly>
      <button class="btn btn-primary btn-sm" onclick="copyShareLink()">Copy</button>
    </div>
  </div>
</div>

<!-- ==================== TRANSACTIONS ==================== -->
<div class="page" id="page-transactions">
  <div class="page-header">
    <div>
      <div class="page-title">Transactions</div>
      <div class="page-subtitle">All income & expenses</div>
    </div>
    <div class="header-actions">
      <input type="text" id="txSearch" placeholder="üîç Search..." style="width:180px;padding:8px 14px" oninput="renderTransactions()">
      <select id="txFilter" onchange="renderTransactions()" style="width:140px;padding:8px 12px">
        <option value="all">All Types</option>
        <option value="income">Income only</option>
        <option value="expense">Expenses only</option>
      </select>
    </div>
  </div>
  <div class="card">
    <div id="txListContainer" class="tx-list">
      <div class="empty-state"><div class="empty-icon">üìã</div><h3>No Transactions</h3><p>Add some using the + button</p></div>
    </div>
  </div>
</div>

<!-- ==================== ANALYTICS ==================== -->
<div class="page" id="page-analytics">
  <div class="page-header">
    <div><div class="page-title">Analytics</div><div class="page-subtitle">Spending patterns & trends</div></div>
  </div>
  <div class="grid grid-2" style="margin-bottom:20px">
    <div class="card">
      <div class="section-title">ü•ß Spending by Category</div>
      <div class="chart-container"><canvas id="pieChart"></canvas></div>
    </div>
    <div class="card">
      <div class="section-title">üìà Monthly Trend</div>
      <div class="chart-container"><canvas id="barChart"></canvas></div>
    </div>
  </div>
  <div class="card">
    <div class="section-title">üìä Category Breakdown</div>
    <div id="categoryBreakdown"></div>
  </div>
</div>

<!-- ==================== BUDGET GOALS ==================== -->
<div class="page" id="page-budget">
  <div class="page-header">
    <div><div class="page-title">Budget Goals</div><div class="page-subtitle">Manage your savings targets</div></div>
    <button class="btn btn-primary" onclick="openGoalModal()">+ New Goal</button>
  </div>
  <div id="goalsContainer">
    <div class="empty-state"><div class="empty-icon">üéØ</div><h3>No Goals Set</h3><p>Set a monthly savings goal to track your progress.</p></div>
  </div>
</div>

<!-- ==================== INCOME ==================== -->
<div class="page" id="page-income">
  <div class="page-header">
    <div><div class="page-title">Income Sources</div><div class="page-subtitle">Track where your money comes from</div></div>
    <button class="btn btn-primary" onclick="openModal('income')">+ Add Income</button>
  </div>
  <div class="grid grid-3" style="margin-bottom:24px" id="incomeSourceCards">
  </div>
  <div class="card">
    <div class="section-title">üíµ All Income</div>
    <div id="incomeList" class="tx-list"></div>
  </div>
</div>

<!-- ==================== CHATBOT ==================== -->
<div class="page" id="page-chatbot">
  <div class="page-header">
    <div><div class="page-title">AI Financial Coach</div><div class="page-subtitle">Your smart money assistant</div></div>
  </div>
  <div class="card" style="height:calc(100vh - 200px)">
    <div class="chat-mode-tabs">
      <button class="mode-tab active" onclick="setChatMode('finance',this)">üíº Finance Coach</button>
      <button class="mode-tab" onclick="setChatMode('assistant',this)">üîç Expense Assistant</button>
      <button class="mode-tab" onclick="setChatMode('fun',this)">üòÑ Fun Chat</button>
    </div>
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="chat-msg ai">
          üëã Hi! I'm your AI Financial Coach. I can help you with budgeting advice, analyze your spending, or just chat! What's on your mind?
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="Ask me anything about your finances..." onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-primary" onclick="sendChat()">Send ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== GAMES ==================== -->
<div class="page" id="page-games">
  <div class="page-header">
    <div><div class="page-title">Fun Zone üéÆ</div><div class="page-subtitle">Learn finance while having fun</div></div>
  </div>
  <div class="grid grid-3" style="margin-bottom:24px">
    <div class="card" style="cursor:pointer;text-align:center" onclick="startGame('dodge')">
      <div style="font-size:36px;margin-bottom:8px">ü™ô</div>
      <div style="font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:4px">Money Saver</div>
      <div style="font-size:13px;color:var(--text2)">Dodge expenses, collect coins!</div>
      <div style="margin-top:12px"><span class="badge badge-purple">High: <span id="dodgeHigh">0</span></span></div>
    </div>
    <div class="card" style="cursor:pointer;text-align:center" onclick="startGame('quiz')">
      <div style="font-size:36px;margin-bottom:8px">üß†</div>
      <div style="font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:4px">Budget Quiz</div>
      <div style="font-size:13px;color:var(--text2)">Test your financial wisdom!</div>
      <div style="margin-top:12px"><span class="badge badge-green">High: <span id="quizHigh">0</span></span></div>
    </div>
    <div class="card" style="cursor:pointer;text-align:center" onclick="startGame('reaction')">
      <div style="font-size:36px;margin-bottom:8px">‚ö°</div>
      <div style="font-family:var(--font-head);font-size:16px;font-weight:700;margin-bottom:4px">Reaction Speed</div>
      <div style="font-size:13px;color:var(--text2)">Tap money icons fast!</div>
      <div style="margin-top:12px"><span class="badge badge-red">High: <span id="reactionHigh">0</span></span></div>
    </div>
  </div>

  <!-- DODGE GAME -->
  <div id="game-dodge" style="display:none" class="card">
    <div class="game-info">
      <div><span style="color:var(--text2);font-size:12px">SCORE</span><div class="game-score" id="dodgeScore">0</div></div>
      <div><span style="color:var(--text2);font-size:12px">LIVES</span><div style="font-size:22px" id="dodgeLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div>
      <button class="btn btn-ghost btn-sm" onclick="stopGame('dodge')">‚úï Exit</button>
    </div>
    <canvas id="dodgeCanvas" class="game-canvas" width="600" height="350" style="width:100%"></canvas>
    <div style="text-align:center;margin-top:10px;font-size:13px;color:var(--text2)">Use ‚Üê ‚Üí arrow keys or tap to move</div>
  </div>

  <!-- QUIZ GAME -->
  <div id="game-quiz" style="display:none" class="card">
    <div class="game-info">
      <div><span style="color:var(--text2);font-size:12px">SCORE</span><div class="game-score" id="quizScore">0</div></div>
      <div><span style="color:var(--text2);font-size:12px">QUESTION</span><div style="font-family:var(--font-head);font-weight:700" id="quizQNum">1/10</div></div>
      <button class="btn btn-ghost btn-sm" onclick="stopGame('quiz')">‚úï Exit</button>
    </div>
    <div id="quizContent">
      <div class="card" style="background:var(--surface2);text-align:center;padding:28px;margin-bottom:16px">
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px">FINANCIAL DECISION</div>
        <div style="font-family:var(--font-head);font-size:18px;font-weight:700;line-height:1.4" id="quizQuestion">Loading...</div>
      </div>
      <div class="game-grid" id="quizOptions"></div>
    </div>
  </div>

  <!-- REACTION GAME -->
  <div id="game-reaction" style="display:none" class="card">
    <div class="game-info">
      <div><span style="color:var(--text2);font-size:12px">SCORE</span><div class="game-score" id="reactionScore">0</div></div>
      <div><span style="color:var(--text2);font-size:12px">TIME</span><div style="font-family:var(--font-head);font-weight:700;font-size:20px" id="reactionTime">30s</div></div>
      <button class="btn btn-ghost btn-sm" onclick="stopGame('reaction')">‚úï Exit</button>
    </div>
    <div id="reactionArea"></div>
    <div style="text-align:center;margin-top:10px;font-size:13px;color:var(--text2)">Tap the money icons as fast as you can!</div>
  </div>

  <!-- LEADERBOARD -->
  <div class="card" style="margin-top:20px">
    <div class="section-title">üèÜ Leaderboard</div>
    <div id="leaderboard"></div>
  </div>
</div>

<!-- ==================== SETTINGS ==================== -->
<div class="page" id="page-settings">
  <div class="page-header">
    <div><div class="page-title">Settings</div><div class="page-subtitle">Customize your experience</div></div>
  </div>
  <div class="grid grid-2">
    <div class="card">
      <div class="section-title">üë§ Profile</div>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
        <div class="profile-avatar" id="avatarInitial">S</div>
        <div>
          <div style="font-family:var(--font-head);font-size:18px;font-weight:700" id="profileName">Student</div>
          <div style="font-size:13px;color:var(--text2)" id="profileEmail">student@university.edu</div>
        </div>
      </div>
      <div class="form-group"><label>Display Name</label><input type="text" id="nameInput" placeholder="Your name" value="Student"></div>
      <div class="form-group"><label>University</label><input type="text" id="uniInput" placeholder="Your university"></div>
      <div class="form-group"><label>Monthly Budget</label><input type="number" id="monthlyBudget" placeholder="1000" value="1000"></div>
      <button class="btn btn-primary" style="width:100%" onclick="saveSettings()">Save Profile</button>
    </div>
    <div class="card">
      <div class="section-title">üé® Preferences</div>
      <div class="setting-row">
        <div>
          <div style="font-weight:500">Dark Mode</div>
          <div style="font-size:12px;color:var(--text2)">Toggle dark/light theme</div>
        </div>
        <label class="switch"><input type="checkbox" id="darkModeToggle" checked onchange="toggleTheme()"><span class="slider"></span></label>
      </div>
      <div class="setting-row">
        <div>
          <div style="font-weight:500">Currency</div>
          <div style="font-size:12px;color:var(--text2)">Display currency symbol</div>
        </div>
        <select id="currencySelect" onchange="saveCurrency()" style="width:80px">
          <option value="$">$ USD</option>
          <option value="‚Çπ">‚Çπ INR</option>
          <option value="‚Ç¨">‚Ç¨ EUR</option>
          <option value="¬£">¬£ GBP</option>
          <option value="¬•">¬• JPY</option>
        </select>
      </div>
      <div class="setting-row">
        <div>
          <div style="font-weight:500">AI Chat Mode</div>
          <div style="font-size:12px;color:var(--text2)">Default chat mode</div>
        </div>
        <select id="defaultChatMode" style="width:120px">
          <option value="finance">Finance</option>
          <option value="assistant">Assistant</option>
          <option value="fun">Fun</option>
        </select>
      </div>
      <div class="divider"></div>
      <div class="section-title" style="margin-bottom:12px">‚ö†Ô∏è Data</div>
      <button class="btn btn-danger" style="width:100%" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
    </div>
  </div>
</div>

</main>
</div>

<!-- FAB -->
<button class="fab" onclick="openModal('expense')" title="Add transaction">+</button>

<!-- ADD TRANSACTION MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add Transaction</div>
      <button class="btn btn-ghost btn-icon" onclick="closeModal()">‚úï</button>
    </div>
    <div class="toggle-tab">
      <button class="toggle-btn" id="incomeTab" onclick="setModalType('income')">üí∞ Income</button>
      <button class="toggle-btn active" id="expenseTab" onclick="setModalType('expense')">üí∏ Expense</button>
    </div>
    <div class="form-group">
      <label>Amount</label>
      <input type="number" id="txAmount" placeholder="0.00" min="0" step="0.01">
    </div>
    <div class="form-group" id="categoryGroup">
      <label>Category</label>
      <select id="txCategory">
        <option value="Food">üçï Food</option>
        <option value="Rent">üè† Rent</option>
        <option value="Travel">üöå Travel</option>
        <option value="Shopping">üõçÔ∏è Shopping</option>
        <option value="Education">üìö Education</option>
        <option value="Health">üíä Health</option>
        <option value="Entertainment">üé¨ Entertainment</option>
        <option value="Other">üì¶ Other</option>
      </select>
    </div>
    <div class="form-group" id="sourceGroup" style="display:none">
      <label>Source</label>
      <select id="txSource">
        <option value="Parent">üë®‚Äçüë©‚Äçüëß Parent / Family</option>
        <option value="Internship">üíº Internship</option>
        <option value="Scholarship">üéì Scholarship</option>
        <option value="Part-time">üõ†Ô∏è Part-time Job</option>
        <option value="Other">üì¶ Other</option>
      </select>
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="txDate">
    </div>
    <div class="form-group">
      <label>Notes (optional)</label>
      <input type="text" id="txNotes" placeholder="What was this for?">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="addTransaction()">Add Transaction</button>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="modal-overlay" id="goalModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Set Savings Goal</div>
      <button class="btn btn-ghost btn-icon" onclick="closeGoalModal()">‚úï</button>
    </div>
    <div class="form-group">
      <label>Target Amount</label>
      <input type="number" id="goalAmount" placeholder="500" min="0">
    </div>
    <div class="form-group">
      <label>Month</label>
      <input type="month" id="goalMonth">
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="saveGoal()">Save Goal</button>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<script>
// ==================== STATE ====================
let state = {
  transactions: [],
  goals: [],
  gameScores: [],
  settings: {name:'Student',email:'student@edu.com',currency:'$',monthlyBudget:1000,theme:'dark',uni:''},
  chatMode: 'finance',
  chatHistory: [],
  currentGame: null,
  gameIntervals: []
};

// ==================== INIT ====================
function init() {
  loadFromStorage();
  updateGreeting();
  setDate();
  updateDashboard();
  renderTransactions();
  renderIncome();
  renderGoals();
  renderLeaderboard();
  applySettings();
  updateCharts();
  document.getElementById('txDate').valueAsDate = new Date();
  const now = new Date();
  document.getElementById('goalMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
}

function loadFromStorage() {
  const saved = localStorage.getItem('studywallet_state');
  if(saved) {
    const parsed = JSON.parse(saved);
    state = {...state, ...parsed};
  }
}

function saveToStorage() {
  localStorage.setItem('studywallet_state', JSON.stringify({
    transactions: state.transactions,
    goals: state.goals,
    gameScores: state.gameScores,
    settings: state.settings
  }));
}

// ==================== NAVIGATION ====================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const navBtns = document.querySelectorAll('.nav-item');
  navBtns.forEach(btn => { if(btn.textContent.toLowerCase().includes(getNavMatch(name))) btn.classList.add('active'); });
  if(name==='analytics') updateCharts();
  if(name==='games') renderLeaderboard();
  if(document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
}

function getNavMatch(name) {
  const map={dashboard:'home',transactions:'transaction',analytics:'analytics',budget:'budget',income:'income',chatbot:'coach',games:'fun',settings:'settings'};
  return map[name]||name;
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sideOverlay').classList.toggle('open');
}

// ==================== SETTINGS & THEME ====================
function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
  document.querySelector('.theme-toggle').textContent = isDark ? 'üåû' : 'üåô';
  document.getElementById('darkModeToggle').checked = !isDark;
  state.settings.theme = isDark?'light':'dark';
  saveToStorage();
}

function applySettings() {
  const s = state.settings;
  if(s.theme==='light') { document.documentElement.setAttribute('data-theme','light'); document.querySelector('.theme-toggle').textContent='üåû'; document.getElementById('darkModeToggle').checked=false; }
  document.getElementById('nameInput').value = s.name||'Student';
  document.getElementById('uniInput').value = s.uni||'';
  document.getElementById('monthlyBudget').value = s.monthlyBudget||1000;
  document.getElementById('currencySelect').value = s.currency||'$';
  document.getElementById('greetName').textContent = s.name||'Student';
  document.getElementById('profileName').textContent = s.name||'Student';
  document.getElementById('profileEmail').textContent = s.email||'student@edu.com';
  document.getElementById('avatarInitial').textContent = (s.name||'S')[0].toUpperCase();
  document.getElementById('sidebarUsername').textContent = s.name||'Student';
}

function saveSettings() {
  state.settings.name = document.getElementById('nameInput').value;
  state.settings.uni = document.getElementById('uniInput').value;
  state.settings.monthlyBudget = parseFloat(document.getElementById('monthlyBudget').value)||1000;
  state.settings.currency = document.getElementById('currencySelect').value;
  saveToStorage();
  applySettings();
  updateDashboard();
  notify('‚úÖ Settings saved!','success');
}

function saveCurrency() {
  state.settings.currency = document.getElementById('currencySelect').value;
  saveToStorage();
  updateDashboard();
  renderTransactions();
  renderIncome();
}

function clearAllData() {
  if(!confirm('This will delete ALL your transactions, goals and scores. Are you sure?')) return;
  state.transactions = []; state.goals = []; state.gameScores = [];
  saveToStorage(); updateDashboard(); renderTransactions(); renderIncome(); renderGoals(); renderLeaderboard(); updateCharts();
  notify('Data cleared','success');
}

// ==================== UTILITIES ====================
const cur = ()=>state.settings.currency||'$';
const fmt = n=>`${cur()}${Math.abs(n).toFixed(2)}`;
const uid = ()=>Date.now().toString(36)+Math.random().toString(36).substr(2);

function setDate() {
  const d = new Date();
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  document.getElementById('dashDate').textContent = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function updateGreeting() {
  const h = new Date().getHours();
  const g = h<12?'Good morning':h<18?'Good afternoon':'Good evening';
  document.querySelector('.page-title').innerHTML = `${g}, <span id="greetName">${state.settings.name||'Student'}</span> ${h<12?'‚òÄÔ∏è':h<18?'üå§Ô∏è':'üåô'}`;
}

function notify(msg, type='info') {
  const el = document.getElementById('notification');
  el.textContent = msg;
  el.className = `notification show ${type}`;
  setTimeout(()=>el.classList.remove('show'), 3000);
}

// ==================== TRANSACTIONS ====================
function openModal(type='expense') {
  setModalType(type);
  document.getElementById('addModal').classList.add('open');
  document.getElementById('txDate').valueAsDate = new Date();
  document.getElementById('txAmount').focus();
}

function closeModal() {
  document.getElementById('addModal').classList.remove('open');
  document.getElementById('txAmount').value='';
  document.getElementById('txNotes').value='';
}

function setModalType(type) {
  state._modalType = type;
  document.getElementById('categoryGroup').style.display = type==='expense'?'block':'none';
  document.getElementById('sourceGroup').style.display = type==='income'?'block':'none';
  document.getElementById('incomeTab').classList.toggle('active', type==='income');
  document.getElementById('expenseTab').classList.toggle('active', type==='expense');
}

function addTransaction() {
  const amount = parseFloat(document.getElementById('txAmount').value);
  if(!amount || amount<=0) { notify('Enter a valid amount','error'); return; }
  const type = state._modalType||'expense';
  const tx = {
    id: uid(),
    type,
    amount,
    category: type==='expense' ? document.getElementById('txCategory').value : document.getElementById('txSource').value,
    date: document.getElementById('txDate').value || new Date().toISOString().split('T')[0],
    notes: document.getElementById('txNotes').value,
    createdAt: Date.now()
  };
  state.transactions.unshift(tx);
  saveToStorage();
  closeModal();
  updateDashboard();
  renderTransactions();
  renderIncome();
  updateCharts();
  notify(`‚úÖ ${type==='income'?'Income':'Expense'} added: ${fmt(amount)}`, 'success');
}

function deleteTransaction(id) {
  if(!confirm('Delete this transaction?')) return;
  state.transactions = state.transactions.filter(t=>t.id!==id);
  saveToStorage();
  updateDashboard();
  renderTransactions();
  renderIncome();
  updateCharts();
  notify('Deleted','success');
}

function getThisMonthTx() {
  const now = new Date();
  const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  return state.transactions.filter(t=>t.date && t.date.startsWith(ym));
}

// ==================== DASHBOARD ====================
function updateDashboard() {
  const txs = getThisMonthTx();
  const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance = income - expense;

  document.getElementById('totalIncome').textContent = fmt(income);
  document.getElementById('totalExpense').textContent = fmt(expense);
  document.getElementById('balance').textContent = fmt(balance);
  document.getElementById('balanceStatus').textContent = balance>0 ? 'üíö Looking good!' : balance===0 ? '‚ö†Ô∏è Break even' : 'üî¥ Over budget!';

  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const daysPassed = now.getDate();
  const daysLeft = daysInMonth - daysPassed;
  const avgDaily = daysPassed > 0 ? expense/daysPassed : 0;
  const survivalDays = avgDaily > 0 ? Math.floor(balance/avgDaily) : (balance>0?daysLeft:0);
  const safeDaily = daysLeft > 0 ? Math.max(0,balance/daysLeft) : 0;

  document.getElementById('survivalDays').textContent = Math.max(0,survivalDays);
  document.getElementById('dailyLimit').textContent = fmt(safeDaily);

  // Savings goal
  const goal = state.goals.find(g=>g.month===`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`);
  if(goal) {
    const saved = Math.max(0,balance);
    const pct = Math.min(100,(saved/goal.target)*100);
    document.getElementById('savingsProgress').textContent = `${fmt(saved)}/${fmt(goal.target)}`;
    document.getElementById('savingsBar').style.width = pct+'%';
    document.getElementById('savingsBar').className = `progress-fill ${pct>=80?'good':pct>=40?'warn':'danger'}`;
    document.getElementById('savingsPct').textContent = `${pct.toFixed(0)}% saved`;
  }

  document.getElementById('sidebarBalance').textContent = `${fmt(balance)} left`;

  // Recent transactions
  const recent = state.transactions.slice(0,5);
  const recentEl = document.getElementById('recentTx');
  if(recent.length===0) {
    recentEl.innerHTML='<div class="empty-state" style="padding:24px"><div class="empty-icon">üì≠</div><div>No transactions yet</div></div>';
  } else {
    recentEl.innerHTML = recent.map(t=>txHTML(t,true)).join('');
  }

  generateInsights(income, expense, balance, avgDaily, txs);
}

function txHTML(t, compact=false) {
  const icons = {Food:'üçï',Rent:'üè†',Travel:'üöå',Shopping:'üõçÔ∏è',Education:'üìö',Health:'üíä',Entertainment:'üé¨',Other:'üì¶',Parent:'üë®‚Äçüë©‚Äçüëß',Internship:'üíº',Scholarship:'üéì','Part-time':'üõ†Ô∏è'};
  const icon = icons[t.category]||'üí≥';
  const colors = {income:'rgba(106,245,184,0.15)',expense:'rgba(245,106,106,0.1)',Food:'rgba(245,190,106,0.15)',Rent:'rgba(106,145,245,0.15)',Travel:'rgba(106,245,245,0.15)',Shopping:'rgba(245,106,200,0.15)'};
  const bg = colors[t.type]||colors[t.category]||'rgba(124,106,245,0.1)';
  return `<div class="tx-item">
    <div class="tx-icon" style="background:${bg}">${icon}</div>
    <div class="tx-info">
      <div class="tx-name">${t.notes||t.category} ${t.type==='income'?'<span class="badge badge-green" style="font-size:10px">Income</span>':''}</div>
      <div class="tx-meta">${t.category} ‚Ä¢ ${t.date}</div>
    </div>
    <div class="tx-amount ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
    ${!compact?`<div class="tx-actions"><button class="btn btn-ghost btn-icon btn-sm" onclick="deleteTransaction('${t.id}')" title="Delete">üóëÔ∏è</button></div>`:''}
  </div>`;
}

function renderTransactions() {
  const search = (document.getElementById('txSearch')?.value||'').toLowerCase();
  const filter = document.getElementById('txFilter')?.value||'all';
  let txs = state.transactions.filter(t=>{
    const matchFilter = filter==='all'||(filter==='income'&&t.type==='income')||(filter==='expense'&&t.type==='expense');
    const matchSearch = !search||(t.category||'').toLowerCase().includes(search)||(t.notes||'').toLowerCase().includes(search);
    return matchFilter && matchSearch;
  });
  const el = document.getElementById('txListContainer');
  if(txs.length===0) {
    el.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><h3>No Transactions</h3><p>Add some using the + button</p></div>';
  } else {
    el.innerHTML = txs.map(t=>txHTML(t)).join('');
  }
}

function renderIncome() {
  const incomes = state.transactions.filter(t=>t.type==='income');
  const sources = {};
  incomes.forEach(t=>{ sources[t.category]=(sources[t.category]||0)+t.amount; });
  const el = document.getElementById('incomeSourceCards');
  const sourceIcons = {Parent:'üë®‚Äçüë©‚Äçüëß',Internship:'üíº',Scholarship:'üéì','Part-time':'üõ†Ô∏è',Other:'üì¶'};
  el.innerHTML = Object.entries(sources).map(([s,a])=>`
    <div class="stat-card balance">
      <div class="stat-label">${s}</div>
      <div class="stat-value">${fmt(a)}</div>
      <div class="stat-sub">Total received</div>
      <div class="stat-icon">${sourceIcons[s]||'üí∞'}</div>
    </div>
  `).join('') || '<div style="grid-column:1/-1;color:var(--text2);padding:20px">No income recorded yet.</div>';
  const incomeList = document.getElementById('incomeList');
  if(incomes.length===0) incomeList.innerHTML='<div class="empty-state"><div class="empty-icon">üíµ</div><h3>No Income Yet</h3></div>';
  else incomeList.innerHTML = incomes.map(t=>txHTML(t)).join('');
}

// ==================== GOALS ====================
function openGoalModal() {
  document.getElementById('goalModal').classList.add('open');
}
function closeGoalModal() {
  document.getElementById('goalModal').classList.remove('open');
}
function saveGoal() {
  const target = parseFloat(document.getElementById('goalAmount').value);
  const month = document.getElementById('goalMonth').value;
  if(!target||!month) { notify('Fill in all fields','error'); return; }
  const existing = state.goals.findIndex(g=>g.month===month);
  const goal = {id:uid(),target,month};
  if(existing>=0) state.goals[existing]=goal;
  else state.goals.push(goal);
  saveToStorage(); closeGoalModal(); updateDashboard(); renderGoals();
  notify('‚úÖ Goal saved!','success');
}
function renderGoals() {
  const el = document.getElementById('goalsContainer');
  if(state.goals.length===0) {
    el.innerHTML='<div class="empty-state"><div class="empty-icon">üéØ</div><h3>No Goals Set</h3><p>Set a monthly savings goal to track your progress.</p></div>';
    return;
  }
  el.innerHTML = state.goals.map(g=>{
    const txs = state.transactions.filter(t=>t.date&&t.date.startsWith(g.month));
    const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const saved = Math.max(0,income-expense);
    const pct = Math.min(100,(saved/g.target)*100);
    return `<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div><span class="section-title" style="margin-bottom:0">üéØ Goal: ${g.month}</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <span style="font-family:var(--font-head);font-size:18px;font-weight:700">${fmt(saved)} / ${fmt(g.target)}</span>
          <button class="btn btn-ghost btn-icon btn-sm" onclick="deleteGoal('${g.id}')">üóëÔ∏è</button>
        </div>
      </div>
      <div class="progress-bar" style="height:12px"><div class="progress-fill ${pct>=80?'good':pct>=40?'warn':'danger'}" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--text2)">
        <span>${pct.toFixed(0)}% achieved</span>
        <span>${pct>=100?'üéâ Goal reached!':pct>=50?'Halfway there!':'Keep going!'}</span>
      </div>
    </div>`;
  }).join('');
}
function deleteGoal(id) {
  state.goals = state.goals.filter(g=>g.id!==id);
  saveToStorage(); renderGoals(); updateDashboard(); notify('Goal deleted','success');
}

// ==================== INSIGHTS ====================
function generateInsights(income, expense, balance, avgDaily, txs) {
  const insights = [];
  const cats = {};
  txs.filter(t=>t.type==='expense').forEach(t=>{ cats[t.category]=(cats[t.category]||0)+t.amount; });
  const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];

  if(income===0) insights.push({type:'info',icon:'‚ÑπÔ∏è',text:'Add your income to get started with budgeting!'});
  if(balance<0) insights.push({type:'alert',icon:'üö®',text:`You're over budget by ${fmt(-balance)}! Cut back on non-essentials.`});
  else if(balance<income*0.1) insights.push({type:'warn',icon:'‚ö†Ô∏è',text:`Only ${fmt(balance)} remaining ‚Äî you're spending fast!`});
  else if(balance>income*0.4) insights.push({type:'good',icon:'üíö',text:`Great! You've saved ${fmt(balance)} (${((balance/income)*100).toFixed(0)}% of income)`});

  if(topCat) insights.push({type:'info',icon:'üìä',text:`Top spending: ${topCat[0]} at ${fmt(topCat[1])} (${((topCat[1]/expense)*100).toFixed(0)}% of expenses)`});

  if(avgDaily>0 && income>0) {
    const target = income/30;
    if(avgDaily > target*1.5) insights.push({type:'warn',icon:'‚ö°',text:`Daily spending (${fmt(avgDaily)}) is 50% above target. Consider reducing!`});
  }

  if(cats['Food']>income*0.3) insights.push({type:'warn',icon:'üçï',text:`Food costs ${fmt(cats['Food'])} (${((cats['Food']/income)*100).toFixed(0)}% of income). Try meal prepping!`});
  if(cats['Entertainment']>income*0.2) insights.push({type:'warn',icon:'üé¨',text:`High entertainment spending: ${fmt(cats['Entertainment'])}. Consider free alternatives!`});

  if(insights.length===0) insights.push({type:'good',icon:'‚ú®',text:'Your finances look healthy this month! Keep it up!'});

  document.getElementById('insightsContainer').innerHTML = insights.slice(0,4).map(i=>
    `<div class="insight-card ${i.type}"><span class="insight-icon">${i.icon}</span>${i.text}</div>`
  ).join('');
}

// ==================== CHARTS ====================
let pieChartInst, barChartInst;

function updateCharts() {
  const txs = getThisMonthTx();
  const expenses = txs.filter(t=>t.type==='expense');
  const cats = {};
  expenses.forEach(t=>{ cats[t.category]=(cats[t.category]||0)+t.amount; });

  const catColors = {'Food':'#f5c86a','Rent':'#6a96f5','Travel':'#6af5f5','Shopping':'#f56af5','Education':'#7c6af5','Health':'#6af5b8','Entertainment':'#f56a6a','Other':'#aaaacc'};

  // Pie
  const pieCanvas = document.getElementById('pieChart');
  if(pieChartInst) pieChartInst.destroy();
  if(Object.keys(cats).length>0) {
    pieChartInst = new Chart(pieCanvas, {
      type:'doughnut',
      data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:Object.keys(cats).map(k=>catColors[k]||'#7c6af5'),borderWidth:2,borderColor:'transparent'}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#8888aa',font:{family:'DM Sans',size:12}}}}}
    });
  } else {
    const ctx = pieCanvas.getContext('2d');
    ctx.clearRect(0,0,pieCanvas.width,pieCanvas.height);
    ctx.fillStyle = '#8888aa';
    ctx.font = '14px DM Sans';
    ctx.textAlign='center';
    ctx.fillText('No expense data yet', pieCanvas.width/2, 140);
  }

  // Bar - last 6 months
  const months = [];
  const monthExpenses = [];
  const monthIncome = [];
  const now = new Date();
  for(let i=5;i>=0;i--) {
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    months.push(d.toLocaleString('default',{month:'short'}));
    const mTxs = state.transactions.filter(t=>t.date&&t.date.startsWith(ym));
    monthExpenses.push(mTxs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
    monthIncome.push(mTxs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
  }
  const barCanvas = document.getElementById('barChart');
  if(barChartInst) barChartInst.destroy();
  barChartInst = new Chart(barCanvas, {
    type:'bar',
    data:{labels:months,datasets:[
      {label:'Income',data:monthIncome,backgroundColor:'rgba(106,245,184,0.6)',borderColor:'#6af5b8',borderWidth:1,borderRadius:6},
      {label:'Expenses',data:monthExpenses,backgroundColor:'rgba(245,106,106,0.6)',borderColor:'#f56a6a',borderWidth:1,borderRadius:6}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8888aa',font:{family:'DM Sans',size:12}}}},scales:{x:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#8888aa'}},y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#8888aa',callback:v=>`${cur()}${v}`}}}}
  });

  // Category breakdown
  const breakdownEl = document.getElementById('categoryBreakdown');
  const total = Object.values(cats).reduce((s,v)=>s+v,0)||1;
  breakdownEl.innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div style="width:36px;height:36px;border-radius:10px;background:${catColors[cat]||'#7c6af5'}33;display:flex;align-items:center;justify-content:center;font-size:18px">${{Food:'üçï',Rent:'üè†',Travel:'üöå',Shopping:'üõçÔ∏è',Education:'üìö',Health:'üíä',Entertainment:'üé¨',Other:'üì¶'}[cat]||'üì¶'}</div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:500;font-size:14px">${cat}</span><span style="font-family:var(--font-mono);font-size:13px">${fmt(amt)}</span></div>
        <div class="progress-bar" style="height:6px"><div class="progress-fill good" style="width:${(amt/total*100).toFixed(0)}%;background:${catColors[cat]||'#7c6af5'}"></div></div>
      </div>
      <div style="font-size:12px;color:var(--text2);width:35px;text-align:right">${(amt/total*100).toFixed(0)}%</div>
    </div>
  `).join('')||'<div class="empty-state"><div class="empty-icon">üìä</div><h3>No data yet</h3></div>';
}

// ==================== SHARE ====================
function generateShareLink() {
  const txs = getThisMonthTx();
  const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const data = btoa(JSON.stringify({name:state.settings.name,income,expense,date:new Date().toLocaleDateString()}));
  const url = `${window.location.href.split('?')[0]}?share=${data}`;
  document.getElementById('shareUrlInput').value = url;
  document.getElementById('shareSection').style.display='block';
  document.getElementById('shareSection').scrollIntoView({behavior:'smooth'});
}
function copyShareLink() {
  navigator.clipboard.writeText(document.getElementById('shareUrlInput').value);
  notify('üîó Link copied!','success');
}

// ==================== AI CHATBOT ====================
const chatModePrompts = {
  finance: `You are a friendly, expert financial coach for students. Give concise, practical budgeting advice. Keep responses short (2-4 sentences). Use emojis occasionally. Format numbers nicely.`,
  assistant: `You are an expense tracking assistant for a student finance app. Answer questions about their spending data concisely. Use the data provided. Keep responses short.`,
  fun: `You are a fun, casual chat buddy for stressed students. Be supportive, funny, and motivating. Keep it short and energetic! Use emojis.`
};

function setChatMode(mode, btn) {
  state.chatMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML = '';
  const intros = {
    finance:'üíº Finance Coach mode! Ask me about budgeting, savings strategies, or get personalized advice based on your spending.',
    assistant:`üîç Expense Assistant mode! I can answer questions like "How much did I spend on food?" or "What's my biggest expense category?"`,
    fun:'üòÑ Fun Chat mode! Stressed about money? Tell me what\'s up and let\'s talk! I\'m here to motivate and support you. üöÄ'
  };
  appendMsg('ai', intros[mode]);
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if(!msg) return;
  input.value = '';
  appendMsg('user', msg);
  const typingId = appendTyping();

  // Build context
  const txs = getThisMonthTx();
  const income = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance = income-expense;
  const cats = {};
  txs.filter(t=>t.type==='expense').forEach(t=>{ cats[t.category]=(cats[t.category]||0)+t.amount; });
  const ctx = `Student financial data: Income this month: ${cur()}${income.toFixed(2)}, Expenses: ${cur()}${expense.toFixed(2)}, Balance: ${cur()}${balance.toFixed(2)}, Top categories: ${JSON.stringify(cats)}`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':state.settings.apiKey||'','anthropic-version':'2023-06-01'},
      body: JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:300,system:chatModePrompts[state.chatMode]+'\n\n'+ctx,messages:[...state.chatHistory,{role:'user',content:msg}]})
    });
    const data = await res.json();
    removeTyping(typingId);
    if(data.content && data.content[0]) {
      const reply = data.content[0].text;
      state.chatHistory = [...state.chatHistory,{role:'user',content:msg},{role:'assistant',content:reply}].slice(-10);
      appendMsg('ai', reply);
    } else {
      // Fallback AI responses
      removeTyping(typingId);
      appendMsg('ai', generateLocalResponse(msg, income, expense, balance, cats));
    }
  } catch(e) {
    removeTyping(typingId);
    appendMsg('ai', generateLocalResponse(msg, income, expense, balance, cats));
  }
}

function generateLocalResponse(msg, income, expense, balance, cats) {
  const m = msg.toLowerCase();
  const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
  if(state.chatMode==='assistant') {
    if(m.includes('food')||m.includes('eat')) return `üçï You spent ${fmt(cats['Food']||0)} on food this month. ${(cats['Food']||0)>income*0.3?'That\'s quite a lot ‚Äî try cooking at home!':'That\'s reasonable!'}`;
    if(m.includes('balance')||m.includes('left')) return `üí≥ Your current balance is ${fmt(balance)}. ${balance>0?`You have money to spare!`:`You're over budget!`}`;
    if(m.includes('most')||m.includes('top')||m.includes('biggest')) return topCat?`üìä Your biggest expense is ${topCat[0]} at ${fmt(topCat[1])} this month.`:`No expenses yet!`;
    if(m.includes('save')||m.includes('saving')) return `üí∞ You've saved ${fmt(Math.max(0,balance))} out of ${fmt(income)} income this month (${income>0?((balance/income)*100).toFixed(0):0}%).`;
    if(m.includes('income')) return `üíµ Total income this month: ${fmt(income)}`;
    if(m.includes('spend')||m.includes('spent')) return `üí∏ Total spending this month: ${fmt(expense)}`;
    return `üìã This month: Income ${fmt(income)}, Expenses ${fmt(expense)}, Balance ${fmt(balance)}. What else would you like to know?`;
  }
  if(state.chatMode==='fun') {
    if(m.includes('stress')||m.includes('worried')||m.includes('broke')) return `Hey, I totally get it! üòÖ Student life is tough. But you're here, tracking your finances ‚Äî that puts you ahead of 80% of people! üí™ One day at a time!`;
    if(m.includes('motivat')) return `You've got this! üöÄ Every rupee you save is a step toward your goals. Small habits = big wins. Keep going! ‚≠ê`;
    return `Haha, love your energy! üòÑ Remember: money is a tool, not the goal. Keep learning, keep hustling, and the cash will follow! üåü`;
  }
  // Finance coach
  if(m.includes('budget')) return `üíº For your ${fmt(income)} monthly income, try the 50/30/20 rule: 50% needs (${fmt(income*0.5)}), 30% wants (${fmt(income*0.3)}), 20% savings (${fmt(income*0.2)}). You're currently spending ${fmt(expense)}.`;
  if(m.includes('save')||m.includes('saving')) return `üéØ To save more: 1) Review your ${topCat?topCat[0]+' expenses':''} ‚Äî your biggest category. 2) Set a savings goal. 3) Pay yourself first ‚Äî transfer savings immediately when money arrives!`;
  if(m.includes('food')||m.includes('eat')) return `üçï Food often eats 25-35% of student budgets. Try batch cooking on Sundays, use student discounts, and pack lunch when possible. Could save ${fmt((cats['Food']||0)*0.3)}/month!`;
  return `üí° Based on your data: income ${fmt(income)}, expenses ${fmt(expense)}, balance ${fmt(balance)}. ${balance>0?`You're doing well ‚Äî ${((balance/income)*100).toFixed(0)}% savings rate!`:`Time to cut back ‚Äî you've exceeded income by ${fmt(-balance)}.`} Want specific advice on any category?`;
}

function appendMsg(role, text) {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `chat-msg ${role}`;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div.id = uid();
}

function appendTyping() {
  const msgs = document.getElementById('chatMessages');
  const div = document.createElement('div');
  const id = uid();
  div.id = 'typing-'+id;
  div.className = 'chat-msg ai typing';
  div.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return id;
}

function removeTyping(id) {
  const el = document.getElementById('typing-'+id);
  if(el) el.remove();
}

// ==================== GAMES ====================
function startGame(name) {
  document.querySelectorAll('[id^="game-"]').forEach(g=>g.style.display='none');
  document.getElementById('game-'+name).style.display='block';
  document.getElementById('game-'+name).scrollIntoView({behavior:'smooth'});
  state.currentGame = name;
  if(name==='dodge') initDodge();
  if(name==='quiz') initQuiz();
  if(name==='reaction') initReaction();
}

function stopGame(name) {
  document.getElementById('game-'+name).style.display='none';
  state.currentGame = null;
  clearAllGameIntervals();
}

function clearAllGameIntervals() {
  state.gameIntervals.forEach(clearInterval);
  state.gameIntervals = [];
}

function saveScore(game, score) {
  const existing = state.gameScores.findIndex(s=>s.game===game&&s.name===state.settings.name);
  if(existing>=0) {
    if(score > state.gameScores[existing].score) state.gameScores[existing].score = score;
  } else {
    state.gameScores.push({id:uid(),game,name:state.settings.name,score});
  }
  const highKey = game+'High';
  const highEl = document.getElementById(highKey);
  if(highEl) {
    const hi = state.gameScores.filter(s=>s.game===game).reduce((m,s)=>Math.max(m,s.score),0);
    highEl.textContent = hi;
  }
  saveToStorage();
  renderLeaderboard();
}

function renderLeaderboard() {
  const el = document.getElementById('leaderboard');
  if(!el) return;
  const games = ['dodge','quiz','reaction'];
  const gameNames = {dodge:'Money Saver',quiz:'Budget Quiz',reaction:'Reaction Speed'};
  let html = '';
  games.forEach(g=>{
    const scores = state.gameScores.filter(s=>s.game===g).sort((a,b)=>b.score-a.score).slice(0,3);
    if(scores.length===0) return;
    html += `<div style="margin-bottom:16px"><div class="section-title" style="font-size:13px;margin-bottom:8px">${gameNames[g]}</div>`;
    scores.forEach((s,i)=>{
      const rankClass = i===0?'gold':i===1?'silver':'bronze';
      html+=`<div class="lb-item"><div class="lb-rank ${rankClass}">${i+1}</div><div style="flex:1;font-weight:500">${s.name}</div><div style="font-family:var(--font-mono);font-weight:700;color:var(--accent)">${s.score}</div></div>`;
    });
    html+='</div>';
  });
  el.innerHTML = html || '<div class="empty-state" style="padding:24px"><div class="empty-icon">üèÜ</div><h3>Play games to get on the board!</h3></div>';

  // Update high scores
  games.forEach(g=>{
    const hi = state.gameScores.filter(s=>s.game===g).reduce((m,s)=>Math.max(m,s.score),0);
    const el2 = document.getElementById(g+'High');
    if(el2) el2.textContent = hi;
  });
}

// --- DODGE GAME ---
let dodgeGame = null;
function initDodge() {
  const canvas = document.getElementById('dodgeCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  clearAllGameIntervals();
  let score=0, lives=3, gameOver=false;
  const player = {x:W/2, y:H-60, w:40, h:40, speed:6};
  let coins=[],hazards=[],keys={};
  let touchX = null;

  function spawnCoin() {
    coins.push({x:Math.random()*(W-20)+10, y:-20, speed:2+Math.random()*2, r:12});
  }
  function spawnHazard() {
    hazards.push({x:Math.random()*(W-30)+15, y:-30, speed:2.5+Math.random()*2.5, w:30, h:30});
  }

  document.onkeydown = e=>{ keys[e.key]=true; };
  document.onkeyup = e=>{ keys[e.key]=false; };
  canvas.ontouchstart = e=>{ e.preventDefault(); touchX=e.touches[0].clientX; };
  canvas.ontouchmove = e=>{ e.preventDefault(); touchX=e.touches[0].clientX; };
  canvas.ontouchend = ()=>{ touchX=null; };

  const gi = setInterval(()=>{
    if(gameOver) return;
    ctx.clearRect(0,0,W,H);

    // Background
    ctx.fillStyle = '#12121f';
    ctx.fillRect(0,0,W,H);

    // Move player
    if(keys['ArrowLeft']||keys['a']) player.x = Math.max(20, player.x-player.speed);
    if(keys['ArrowRight']||keys['d']) player.x = Math.min(W-20, player.x+player.speed);
    if(touchX) {
      const rect = canvas.getBoundingClientRect();
      const tx = (touchX-rect.left)*(W/rect.width);
      if(Math.abs(tx-player.x)>5) player.x += (tx-player.x)*0.12;
    }

    // Draw player (student avatar)
    ctx.fillStyle='#7c6af5'; ctx.beginPath(); ctx.roundRect(player.x-player.w/2,player.y-player.h/2,player.w,player.h,8); ctx.fill();
    ctx.fillStyle='#fff'; ctx.font='24px serif'; ctx.textAlign='center'; ctx.fillText('üéì', player.x, player.y+8);

    // Coins
    coins.forEach((c,i)=>{
      c.y+=c.speed;
      ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fillStyle='rgba(245,200,106,0.3)'; ctx.fill();
      ctx.fillStyle='#f5c86a'; ctx.beginPath(); ctx.arc(c.x,c.y,c.r-2,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#f5a000'; ctx.font='14px serif'; ctx.textAlign='center'; ctx.fillText('üí∞',c.x,c.y+5);
      const dx=c.x-player.x, dy=c.y-player.y;
      if(Math.sqrt(dx*dx+dy*dy)<c.r+18) { coins.splice(i,1); score+=10; document.getElementById('dodgeScore').textContent=score; }
      if(c.y>H+20) coins.splice(i,1);
    });

    // Hazards
    hazards.forEach((h,i)=>{
      h.y+=h.speed;
      ctx.fillStyle='rgba(245,106,106,0.3)'; ctx.roundRect(h.x-h.w/2,h.y-h.h/2,h.w,h.h,6); ctx.fill();
      ctx.font='20px serif'; ctx.textAlign='center'; ctx.fillText('üí∏',h.x,h.y+6);
      if(h.x>player.x-player.w/2-h.w/2&&h.x<player.x+player.w/2+h.w/2&&h.y>player.y-player.h/2-h.h/2&&h.y<player.y+player.h/2+h.h/2) {
        hazards.splice(i,1); lives--;
        const livesEl=document.getElementById('dodgeLives');
        livesEl.textContent='‚ù§Ô∏è'.repeat(Math.max(0,lives))+'üñ§'.repeat(Math.max(0,3-lives));
        if(lives<=0) { gameOver=true; endDodge(score); }
      }
      if(h.y>H+30) hazards.splice(i,1);
    });

    // Score
    ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.font='14px JetBrains Mono'; ctx.textAlign='left'; ctx.fillText(`Score: ${score}`,10,20);
  }, 1000/60);

  const coinTimer = setInterval(()=>{ if(!gameOver) spawnCoin(); }, 1200);
  const hazardTimer = setInterval(()=>{ if(!gameOver) spawnHazard(); }, 900);
  state.gameIntervals = [gi, coinTimer, hazardTimer];
}

function endDodge(score) {
  clearAllGameIntervals();
  const canvas = document.getElementById('dodgeCanvas');
  const ctx = canvas.getContext('2d');
  ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.font='bold 32px Syne'; ctx.textAlign='center'; ctx.fillText('Game Over!',canvas.width/2,130);
  ctx.font='20px DM Sans'; ctx.fillText(`Score: ${score}`,canvas.width/2,170);
  ctx.fillStyle='#7c6af5'; ctx.font='16px DM Sans'; ctx.fillText('Click/tap to restart',canvas.width/2,220);
  saveScore('dodge', score);
  canvas.onclick = ()=>{ canvas.onclick=null; initDodge(); document.getElementById('dodgeLives').textContent='‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è'; document.getElementById('dodgeScore').textContent='0'; };
}

// --- QUIZ GAME ---
const quizQuestions = [
  {q:"You get $200 pocket money. What's the best first step?",opts:["Spend on fun","Put $40 in savings","Buy clothes","Order food"],correct:1,explain:"Pay yourself first! Save 20% immediately."},
  {q:"Your food budget runs out mid-month. What do you do?",opts:["Use credit card","Skip meals","Cook cheap meals","Ask friends"],correct:2,explain:"Cook rice, pasta and cheap meals ‚Äî healthy AND affordable!"},
  {q:"You find a great deal on a laptop: 50% off. But you don't need one. Buy it?",opts:["Yes, great deal!","No, it's a want not need","Maybe split with friend","Ask parents"],correct:1,explain:"A deal on something you don't need is still unnecessary spending!"},
  {q:"Best place to keep your emergency fund?",opts:["Crypto","Savings account","Under mattress","Invest in stocks"],correct:1,explain:"High-yield savings account: safe, accessible, earns interest."},
  {q:"You have $50 left for 10 days. Daily budget should be?",opts:["$10","$5","$8","$6"],correct:1,explain:"$50 √∑ 10 days = $5/day is the sustainable daily budget."},
  {q:"Which is a 'need' vs 'want'?",opts:["Netflix subscription","Textbooks","Designer shoes","Gaming PC"],correct:1,explain:"Textbooks are essential for education ‚Äî a genuine need!"},
  {q:"You owe $200 on your credit card. You have $300. What to do?",opts:["Invest the $300","Pay off the debt first","Save all $300","Spend some"],correct:1,explain:"Credit card interest is typically 20-30%! Pay debt first."},
  {q:"Best way to reduce food expenses as a student?",opts:["Eat out less","Meal prep at home","Buy brand food","Order delivery"],correct:1,explain:"Meal prepping at home can save 60-70% vs eating out!"},
  {q:"Your friend asks to borrow $50. They often forget to repay. You...",opts:["Lend immediately","Lend only what you can afford to lose","Refuse","Tell your parents"],correct:1,explain:"Only lend money you're okay not getting back ‚Äî protect your budget!"},
  {q:"Which habit builds wealth over time?",opts:["Spending bonuses","Regular small savings","Avoiding all debt","Buying lottery"],correct:1,explain:"Consistent small savings, invested early, grows dramatically through compounding!"}
];

let quizState = {current:0, score:0, answered:false};

function initQuiz() {
  quizState = {current:0, score:0, answered:false};
  document.getElementById('quizScore').textContent = '0';
  showQuizQuestion();
}

function showQuizQuestion() {
  const q = quizQuestions[quizState.current];
  if(!q) { endQuiz(); return; }
  document.getElementById('quizQNum').textContent = `${quizState.current+1}/${quizQuestions.length}`;
  document.getElementById('quizQuestion').textContent = q.q;
  document.getElementById('quizOptions').innerHTML = q.opts.map((o,i)=>`
    <div class="game-card" onclick="answerQuiz(${i})" id="qopt-${i}">
      <div style="font-size:22px;margin-bottom:8px">${['üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë'][i]}</div>
      <div style="font-size:14px;font-weight:500">${o}</div>
    </div>
  `).join('');
  quizState.answered = false;
}

function answerQuiz(idx) {
  if(quizState.answered) return;
  quizState.answered = true;
  const q = quizQuestions[quizState.current];
  const opts = document.querySelectorAll('#quizOptions .game-card');
  opts[q.correct].classList.add('correct');
  if(idx!==q.correct) opts[idx].classList.add('wrong');
  if(idx===q.correct) {
    quizState.score+=10;
    document.getElementById('quizScore').textContent = quizState.score;
    notify('‚úÖ Correct! +10 points','success');
  } else {
    notify(`‚ùå ${q.explain}`,'error');
  }
  setTimeout(()=>{ quizState.current++; showQuizQuestion(); }, 1800);
}

function endQuiz() {
  const pct = (quizState.score/100)*100;
  document.getElementById('quizContent').innerHTML = `
    <div class="survival-meter" style="text-align:center;padding:40px">
      <div style="font-size:48px;margin-bottom:12px">${pct>=80?'üèÜ':pct>=50?'üéØ':'üí™'}</div>
      <div style="font-family:var(--font-head);font-size:36px;font-weight:800;color:var(--accent)">${quizState.score}/100</div>
      <div style="font-size:14px;color:var(--text2);margin:8px 0 20px">${pct>=80?'Financial genius!':pct>=50?'Good knowledge!':'Keep learning!'}</div>
      <button class="btn btn-primary" onclick="initQuiz()">Play Again</button>
    </div>`;
  saveScore('quiz', quizState.score);
}

// --- REACTION GAME ---
let reactionState = {score:0, timeLeft:30, interval:null, spawnInterval:null};

function initReaction() {
  clearAllGameIntervals();
  reactionState = {score:0, timeLeft:30};
  document.getElementById('reactionScore').textContent='0';
  document.getElementById('reactionTime').textContent='30s';
  const area = document.getElementById('reactionArea');
  area.innerHTML='';

  const icons = ['üí∞','üíµ','üí¥','üí∂','üí∑','ü™ô','üí≤','ü§ë'];

  function spawnMoney() {
    const rect = area.getBoundingClientRect();
    const el = document.createElement('div');
    el.className = 'reaction-target';
    el.style.left = Math.random()*Math.max(1,area.offsetWidth-70)+'px';
    el.style.top = Math.random()*Math.max(1,260)+'px';
    el.style.background = `hsl(${Math.random()*60+30},80%,60%)`;
    el.style.color = '#fff';
    el.textContent = icons[Math.floor(Math.random()*icons.length)];
    el.onclick = ()=>{
      el.remove(); reactionState.score+=5;
      document.getElementById('reactionScore').textContent=reactionState.score;
      spawnMoney();
    };
    area.appendChild(el);
    setTimeout(()=>{ if(el.parentNode) { el.remove(); } }, 2000);
  }

  for(let i=0;i<3;i++) spawnMoney();

  const timer = setInterval(()=>{
    reactionState.timeLeft--;
    document.getElementById('reactionTime').textContent = reactionState.timeLeft+'s';
    if(reactionState.timeLeft<=0) {
      clearInterval(timer); clearInterval(spawn);
      state.gameIntervals=[];
      area.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px">
        <div style="font-size:40px">‚è±Ô∏è</div>
        <div style="font-family:var(--font-head);font-size:28px;font-weight:800;color:var(--accent)">Score: ${reactionState.score}</div>
        <button class="btn btn-primary" onclick="initReaction()">Play Again</button>
      </div>`;
      saveScore('reaction', reactionState.score);
    }
  }, 1000);

  const spawn = setInterval(spawnMoney, 1400);
  state.gameIntervals = [timer, spawn];
}

// ==================== KEYBOARD SHORTCUTS ====================
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') { closeModal(); closeGoalModal(); }
});

// ==================== START ====================
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
